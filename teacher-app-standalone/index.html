<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ù„Ù…Ù‡ Ù…Ù‡Ø§ÙˆÙŠ</title>
  <link rel="manifest" href="./manifest.json">
  <style>
    :root {
      --bg: #ffffff; --text: #222222; --header: #2c3e50; --muted:#777;
      --primary: #27ae60; --danger:#e74c3c; --secondary:#bdc3c7; --chip:#ecf0f1;
      --card-border:#e0e0e0; --shadow: rgba(0,0,0,.15);
    }
    [data-theme="dark"] {
      --bg: #111418; --text:#e6e6e6; --header:#0f172a; --muted:#a0a0a0;
      --primary:#2ecc71; --danger:#ff6b6b; --secondary:#475569; --chip:#1f2937;
      --card-border:#263043; --shadow: rgba(0,0,0,.45);
    }
    body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; margin: 0; background:var(--bg); color:var(--text); }
    header { background:var(--header); color:#fff; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:18px; }
    .container { padding:12px; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .toolbar select, .toolbar button, .toolbar input { padding:8px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
    nav { display:flex; gap:8px; flex-wrap:wrap; margin:12px 0; }
    nav button { padding:8px 12px; border:none; border-radius:20px; background:var(--chip); cursor:pointer; color:var(--text); }
    nav button.active { background:#2980b9; color:#fff; }
    section { display:none; }
    section.active { display:block; }
    .card { border:1px solid var(--card-border); border-radius:8px; padding:12px; margin-bottom:10px; background:transparent; }
    .list { display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; }
    .list .name { font-weight:600; }
    .actions { display:flex; gap:6px; align-items:center; }
    .actions button { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; }
    .primary { background:var(--primary); color:#fff; }
    .danger { background:var(--danger); color:#fff; }
    .secondary { background:var(--secondary); color:#fff; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .input { display:flex; flex-direction:column; gap:6px; }
    .input label { font-size:12px; color:#555; }
    .input input, .input select, .input textarea { padding:8px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
    .sticky-footer { position:sticky; bottom:0; background:#f7f9fa; border-top:1px solid #eaeaea; padding:10px; display:flex; justify-content:space-between; align-items:center; }
    .muted { color:var(--muted); font-size:12px; }
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:1000; }
    .modal .box { background:var(--bg); border-radius:10px; padding:16px; width:92%; max-width:380px; box-shadow:0 8px 24px var(--shadow); color:var(--text); }
    .modal .box h3 { margin:0 0 12px 0; font-size:16px; color:#2c3e50; }
    .modal .box .input { margin-bottom:10px; }
    .modal .box .actions { display:flex; gap:8px; justify-content:flex-end; }
    .modal .box .actions button { padding:8px 12px; border:none; border-radius:6px; }
    .toast { position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:10px 14px; border-radius:8px; opacity:0; pointer-events:none; transition:opacity .2s; z-index:1100; }
    .toast.show { opacity:1; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; gap:10px;">
      <h1>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ù„Ù…Ù‡ Ù…Ù‡Ø§ÙˆÙŠ</h1>
      <button id="profileBtn" style="background:#f39c12; border:none; color:white; padding:4px 12px; border-radius:20px; font-size:14px; cursor:pointer; display:flex; align-items:center; gap:6px;">
        ğŸ‘¤ <span id="currentProfileName">Ø§Ù„Ù…Ø¹Ù„Ù…Ø©</span>
      </button>
    </div>
    <div style="display:flex; gap:8px;">
      <button id="exportBtn" class="secondary">ØªØµØ¯ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
      <input id="importFile" type="file" accept="application/json" style="display:none;">
      <button id="importBtn" class="secondary">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø©</button>
    </div>
  </header>
  <div class="container">
    <div class="toolbar">
      <select id="classSelect"></select>
      <button id="addClassBtn" class="secondary">Ø¥Ø¶Ø§ÙØ© ÙØµÙ„</button>
      <button id="addStudentBtn" class="secondary">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
      <input id="todayInput" type="date">
    </div>

    <nav>
      <button data-tab="students">Ø§Ù„Ø·Ù„Ø§Ø¨</button>
      <button data-tab="attendance" class="active">Ø§Ù„Ø­Ø¶ÙˆØ±</button>
      <button data-tab="assignments">Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</button>
      <button data-tab="prep">Ø§Ù„ØªØ­Ø¶ÙŠØ±</button>
      <button data-tab="messages">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</button>
      <button data-tab="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
      <button data-tab="tools">Ø£Ø¯ÙˆØ§Øª</button>
      <button data-tab="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </nav>

    <section id="students">
      <div class="card">
        <div class="input">
          <label>Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨/Ø©</label>
          <input id="studentSearch" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ø§Ø³Ù…">
        </div>
      </div>
      <div class="card">
        <div id="studentsList"></div>
      </div>
    </section>

    <section id="attendance" class="active">
      <div class="card">
        <div class="list" id="attendanceList"></div>
      </div>
      <div class="sticky-footer">
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="allPresentBtn" class="primary">Ø§Ù„ÙƒÙ„ Ø­Ø§Ø¶Ø±</button>
          <button id="allAbsentBtn" class="danger">Ø§Ù„ÙƒÙ„ ØºØ§Ø¦Ø¨</button>
          <div class="muted">Ø§Ø¶ØºØ·ÙŠ Ø­Ø§Ø¶Ø±/ØºØ§Ø¦Ø¨ Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨ Ø«Ù… Ø§Ø­ÙØ¸ÙŠ</div>
        </div>
        <button id="saveAttendanceBtn" class="primary">Ø­ÙØ¸ Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</button>
      </div>
    </section>

    <section id="prep">
      <div class="grid-2">
        <div class="card">
          <div class="input">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¯Ø±Ø³</label>
            <input id="prepDate" type="date">
          </div>
          <div class="input">
            <label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
            <div style="display:flex; gap:6px;">
                <select id="prepSubject" style="flex:1">
                  <option value="Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                  <option value="Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
                  <option value="Ø§Ù„Ø¹Ù„ÙˆÙ…">Ø§Ù„Ø¹Ù„ÙˆÙ…</option>
                  <option value="Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©">Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</option>
                  <option value="Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª">Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª</option>
                  <option value="Ø§Ù„ÙÙ†ÙˆÙ†">Ø§Ù„ÙÙ†ÙˆÙ†</option>
                  <option value="Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©">Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©</option>
                  <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                </select>
                <button id="suggestPrepBtn" class="secondary" title="Ø§Ù‚ØªØ±Ø§Ø­ ØªØ­Ø¶ÙŠØ± Ø¬Ø§Ù‡Ø²">âœ¨ Ø§Ù‚ØªØ±Ø§Ø­</button>
            </div>
          </div>
          <div class="input">
            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³ / Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
            <input id="prepTopic" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³">
          </div>
          <div class="input">
            <label>Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</label>
            <textarea id="prepObjectives" rows="3" placeholder="Ù†Ù‚Ø§Ø· Ù…Ø®ØªØµØ±Ø© Ù„Ù„Ø£Ù‡Ø¯Ø§Ù"></textarea>
          </div>
          <div class="input">
            <label>Ø§Ù„Ø£Ù†Ø´Ø·Ø© / Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª</label>
            <textarea id="prepActivities" rows="3" placeholder="Ù†Ø´Ø§Ø· ØªÙ…Ù‡ÙŠØ¯ÙŠØŒ ØªØ¹Ù„ÙŠÙ…ÙŠØŒ Ø®ØªØ§Ù…ÙŠ"></textarea>
          </div>
          <div class="input">
            <label>Ø§Ù„ÙˆØ³Ø§Ø¦Ù„ / Ø§Ù„Ù…ÙˆØ§Ø¯</label>
            <textarea id="prepMaterials" rows="2" placeholder="Ø¨Ø·Ø§Ù‚Ø§ØªØŒ Ø³Ø¨ÙˆØ±Ø©ØŒ ÙƒØªØ§Ø¨ØŒ Ø£ÙˆØ±Ø§Ù‚..."></textarea>
          </div>
          <div class="input">
            <label>Ø§Ù„ÙˆØ§Ø¬Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="prepHomework" placeholder="ÙˆØ§Ø¬Ø¨ Ù…Ù†Ø²Ù„ÙŠ Ø¥Ù† ÙˆØ¬Ø¯">
          </div>
          <div class="input">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªÙ‚ÙŠÙŠÙ…ÙŠØ©</label>
            <textarea id="prepNotes" rows="2" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø³Ù„ÙˆÙƒÙŠØ©/Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ù…Ø®ØªØµØ±Ø©"></textarea>
          </div>
          <div class="actions" style="justify-content:flex-start; margin-top:8px;">
            <button id="savePrepBtn" class="primary">Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¶ÙŠØ±</button>
            <button id="resetPrepBtn" class="secondary">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          </div>
        </div>
        <div class="card">
          <div class="input">
            <label>ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input id="prepFilterDate" type="date">
          </div>
          <div class="input">
            <label>Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <input id="prepSearch" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
          </div>
          <button id="exportPrepBtn" class="secondary">ØªØµØ¯ÙŠØ± Ø§Ù„ØªØ­Ø¶ÙŠØ± (CSV)</button>
          <div id="prepList"></div>
        </div>
      </div>
    </section>

    <section id="assignments">
      <div class="grid-2">
        <div class="card">
          <div class="input">
            <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ§Ø¬Ø¨</label>
            <input id="asTitle" placeholder="Ù…Ø«Ù„: ÙˆØ§Ø¬Ø¨ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ØµÙØ­Ø© 10">
          </div>
          <div class="input">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…</label>
            <input id="asDue" type="date">
          </div>
          <button id="createAssignmentBtn" class="primary">Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø¬Ø¨</button>
        </div>
        <div class="card">
          <div id="assignmentsList"></div>
        </div>
      </div>
    </section>

    <section id="messages">
      <div class="card">
        <div class="grid-2">
          <div class="input">
            <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨</label>
            <select id="msgStudentSelect"></select>
          </div>
          <div class="input">
            <label>Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
            <select id="msgTemplateSelect">
              <option value="Ù†Ø¬Ø§Ø­_ÙˆØ§Ø¬Ø¨">Ø§Ø¨Ù†Ùƒ/Ø§Ø¨Ù†ØªÙƒ Ø£Ù†Ø¬Ø² Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­.</option>
              <option value="Ù…ØªØ§Ø¨Ø¹Ø©_Ù‚Ø¨Ù„_Ø§Ù„Ù…ÙˆØ¹Ø¯">Ù†Ø­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ÙˆØ§Ø¬Ø¨ Ù‚Ø¨Ù„ Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ³Ù„ÙŠÙ….</option>
              <option value="Ø³Ù„ÙˆÙƒ_Ø¬ÙŠØ¯">Ø³Ù„ÙˆÙƒ Ø¬Ù…ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ØŒ Ø´ÙƒØ±Ù‹Ø§ Ù„Ù„Ø¯Ø¹Ù….</option>
              <option value="Ø³Ù„ÙˆÙƒ_ÙŠØ­ØªØ§Ø¬_Ù…ØªØ§Ø¨Ø¹Ø©">Ù†Ø­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØµÙ„.</option>
            </select>
          </div>
        </div>
        <button id="sendMsgBtn" class="primary">ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ø±Ø³Ø§Ù„Ø©</button>
      </div>
    </section>

    <section id="reports">
      <div class="card">
        <button id="weeklyReportBtn" class="secondary">ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ (CSV)</button>
        <div id="reportStatus" class="muted"></div>
      </div>
    </section>

    <section id="tools">
      <div class="grid-2">
        <div class="card" style="text-align:center; padding:32px;">
          <h3 style="margin-top:0;">ğŸ² Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ</h3>
          <div id="randomPickerResult" style="font-size:24px; font-weight:bold; margin:24px 0; min-height:36px; color:var(--primary);">...</div>
          <button id="pickRandomBtn" class="primary" style="font-size:16px; padding:10px 20px;">Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨Ø©</button>
        </div>
        <div class="card" style="text-align:center; padding:32px;">
          <h3 style="margin-top:0;">â±ï¸ Ù…Ø¤Ù‚Øª Ø§Ù„Ø£Ù†Ø´Ø·Ø©</h3>
          <div id="timerDisplay" style="font-size:48px; font-weight:bold; margin:16px 0; font-family:monospace; direction:ltr;">05:00</div>
          <div style="display:flex; justify-content:center; gap:8px; margin-bottom:16px;">
            <button id="timerAdd1" class="secondary">+1 Ø¯</button>
            <button id="timerSub1" class="secondary">-1 Ø¯</button>
          </div>
          <div style="display:flex; justify-content:center; gap:8px;">
            <button id="timerStartBtn" class="primary">Ø§Ø¨Ø¯Ø£</button>
            <button id="timerPauseBtn" class="secondary">Ø¥ÙŠÙ‚Ø§Ù</button>
            <button id="timerResetBtn" class="danger">Ø¥Ø¹Ø§Ø¯Ø©</button>
          </div>
        </div>
      </div>
    </section>

    <section id="settings">
      <div class="card">
        <div class="input">
          <label>Ø±Ù…Ø² Ø¯Ø®ÙˆÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="pinInput" type="password" placeholder="Ø£Ø±Ø¨Ø¹Ø© Ø£Ø±Ù‚Ø§Ù…">
        </div>
        <button id="savePinBtn" class="primary">Ø­ÙØ¸</button>
      </div>
    </section>
  </div>

  <div id="profilesModal" class="modal">
    <div class="box">
      <h3>ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ / Ø§Ù„Ù…Ø¹Ù„Ù…Ø©</h3>
      <div id="profilesList" style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px;"></div>
      <div class="input">
         <input id="newProfileName" placeholder="Ø§Ø³Ù… Ù…Ø¹Ù„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©">
      </div>
      <div class="actions">
         <button id="addNewProfileBtn" class="primary">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
         <button onclick="document.getElementById('profilesModal').style.display='none'" class="secondary">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      try {
        const swUrl = new URL('./sw.js', location.href).href;
        navigator.serviceWorker.register(swUrl, { scope: './' }).catch(()=>{});
      } catch {}
    }
    // Toast
    const toast = document.createElement('div'); toast.className='toast'; document.body.appendChild(toast);
    function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1800); }

    const profileManager = {
      profiles: [],
      currentId: 'v1',
      init() {
        try {
          const raw = localStorage.getItem('layali_profiles');
          this.profiles = raw ? JSON.parse(raw) : [];
          if (!this.profiles.length) {
             // Migration: Create default
             this.profiles = [{ id:'v1', name:'Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©' }];
             localStorage.setItem('layali_profiles', JSON.stringify(this.profiles));
          }
          const cur = localStorage.getItem('layali_current_profile');
          if (cur && this.profiles.find(p=>p.id===cur)) this.currentId = cur;
          else {
             this.currentId = this.profiles[0].id;
             localStorage.setItem('layali_current_profile', this.currentId);
          }
          const nameEl = document.getElementById('currentProfileName');
          if(nameEl) nameEl.textContent = this.getCurrentName();
        } catch(e){}
      },
      getCurrentName() {
        const p = this.profiles.find(x=>x.id===this.currentId);
        return p ? p.name : 'Ø§Ù„Ù…Ø¹Ù„Ù…Ø©';
      },
      addProfile(name) {
        const id = 'user_' + Math.random().toString(36).slice(2,9);
        this.profiles.push({ id, name });
        localStorage.setItem('layali_profiles', JSON.stringify(this.profiles));
        this.switchProfile(id);
      },
      switchProfile(id) {
        localStorage.setItem('layali_current_profile', id);
        location.reload();
      }
    };
    profileManager.init();

    // Profile UI
    const profileBtn = document.getElementById('profileBtn');
    if (profileBtn) {
        profileBtn.addEventListener('click', ()=>{
          const list = document.getElementById('profilesList');
          list.innerHTML = '';
          profileManager.profiles.forEach(p => {
            const row = document.createElement('div');
            row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
            row.style.padding='8px'; row.style.background = p.id === profileManager.currentId ? '#e8f5e9' : '#f9f9f9';
            row.style.borderRadius='6px';
            
            const n = document.createElement('span'); n.textContent = p.name + (p.id===profileManager.currentId ? ' (Ø£Ù†ØªÙ)' : '');
            const btn = document.createElement('button'); btn.className='secondary'; btn.textContent='Ø¯Ø®ÙˆÙ„';
            if (p.id !== profileManager.currentId) {
              btn.addEventListener('click', ()=> profileManager.switchProfile(p.id));
            } else {
              btn.style.display='none';
            }
            row.appendChild(n); row.appendChild(btn); list.appendChild(row);
          });
          document.getElementById('profilesModal').style.display='flex';
        });
    }
    const addNewProfileBtn = document.getElementById('addNewProfileBtn');
    if (addNewProfileBtn) {
        addNewProfileBtn.addEventListener('click', ()=>{
          const name = document.getElementById('newProfileName').value.trim();
          if (!name) return alert('Ø£Ø¯Ø®Ù„ÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©');
          profileManager.addProfile(name);
        });
    }

    const store = {
      data: { classes: [], students: [], attendance: [], assignments: [], submissions: [], notes: [], preps: [], templates: [], pin: '', theme:'' },
      load() {
        try { 
          const key = 'teacher_app_standalone_' + profileManager.currentId;
          const raw = localStorage.getItem(key); 
          this.data = raw ? JSON.parse(raw) : this.data; 
        } catch (e) {}
      },
      save() { 
        const key = 'teacher_app_standalone_' + profileManager.currentId;
        localStorage.setItem(key, JSON.stringify(this.data)); 
      },
      uid() { return Math.random().toString(36).slice(2, 9); }
    };
    store.load();
    // Theme
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.setAttribute('data-theme', store.data.theme || (prefersDark ? 'dark' : ''));
    if (!Array.isArray(store.data.notes)) store.data.notes = [];
    if (!Array.isArray(store.data.preps)) store.data.preps = [];
    // Ensure stars
    store.data.students.forEach(s => { if(typeof s.stars !== 'number') s.stars = 0; });

    if (!Array.isArray(store.data.templates)) store.data.templates = [];
    const requiredTemplates = [
      { key: 'Ù†Ø¬Ø§Ø­_ÙˆØ§Ø¬Ø¨', text: 'Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ {name} Ø£Ù†Ø¬Ø²/Øª Ø§Ù„ÙˆØ§Ø¬Ø¨ Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­. Ø´ÙƒØ±Ù‹Ø§ Ù„Ù„Ø¯Ø¹Ù….' },
      { key: 'Ù…ØªØ§Ø¨Ø¹Ø©_Ù‚Ø¨Ù„_Ø§Ù„Ù…ÙˆØ¹Ø¯', text: 'Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ Ù†Ø­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ø¬Ø¨ {title} Ù‚Ø¨Ù„ Ø§Ù„Ù…ÙˆØ¹Ø¯.' },
      { key: 'Ø³Ù„ÙˆÙƒ_Ø¬ÙŠØ¯', text: 'Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ Ø³Ù„ÙˆÙƒ {name} ÙƒØ§Ù† Ø¬Ù…ÙŠÙ„Ù‹Ø§ Ø§Ù„ÙŠÙˆÙ…. Ø´ÙƒØ±Ù‹Ø§ Ù„ØªØ¹Ø§ÙˆÙ†ÙƒÙ….' },
      { key: 'Ø³Ù„ÙˆÙƒ_ÙŠØ­ØªØ§Ø¬_Ù…ØªØ§Ø¨Ø¹Ø©', text: 'Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ Ù†Ø­ØªØ§Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© Ø³Ù„ÙˆÙƒ {name} Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØµÙ„.' },
      { key: 'ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù†Ø¬ÙˆÙ…', text: 'Ù…Ø¨Ø§Ø±Ùƒ! Ø­ØµÙ„Øª Ø§Ø¨Ù†ØªÙƒÙ… {name} Ø¹Ù„Ù‰ {stars} Ù†Ø¬Ù…Ø© Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù„ØªÙ…ÙŠØ²Ù‡Ø§. ğŸŒŸ' }
    ];
    let templatesChanged = false;
    requiredTemplates.forEach(req => {
      if (!store.data.templates.find(t => t.key === req.key)) {
        store.data.templates.push({ id: store.uid(), ...req });
        templatesChanged = true;
      }
    });
    if (templatesChanged) store.save();

    const todayInput = document.getElementById('todayInput');
    todayInput.value = new Date().toISOString().slice(0, 10);
    const classSelect = document.getElementById('classSelect');
    const msgStudentSelect = document.getElementById('msgStudentSelect');
    const attendanceList = document.getElementById('attendanceList');
    const studentsList = document.getElementById('studentsList');
    const prepList = document.getElementById('prepList');
    const prepDateInput = document.getElementById('prepDate');
    const prepFilterDateInput = document.getElementById('prepFilterDate');
    prepDateInput && (prepDateInput.value = new Date().toISOString().slice(0,10));
    prepFilterDateInput && (prepFilterDateInput.value = new Date().toISOString().slice(0,10));

    function renderClassSelect() {
      classSelect.innerHTML = '';
      store.data.classes.forEach(c => {
        const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name; classSelect.appendChild(opt);
      });
      if (!store.data.classes.length) {
        const id = store.uid(); store.data.classes.push({ id, name: 'ÙØµÙ„ 1' }); store.save(); renderClassSelect();
      }
    }
    function renderStudentsForClass() {
      const cid = classSelect.value;
      const students = store.data.students.filter(s => s.classId === cid);
      attendanceList.innerHTML = '';
      renderStudentsTab(students);
      students.forEach(s => {
        const row = document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='1fr auto auto'; row.style.gap='8px';
        const name = document.createElement('div'); name.className='name'; name.textContent = s.name;
        const presentBtn = document.createElement('button'); presentBtn.className='primary'; presentBtn.textContent='Ø­Ø§Ø¶Ø±';
        const absentBtn = document.createElement('button'); absentBtn.className='danger'; absentBtn.textContent='ØºØ§Ø¦Ø¨';
        presentBtn.addEventListener('click', () => markAttendance(s.id, true));
        absentBtn.addEventListener('click', () => markAttendance(s.id, false));
        row.appendChild(name); row.appendChild(presentBtn); row.appendChild(absentBtn); attendanceList.appendChild(row);
      });
      msgStudentSelect.innerHTML = '';
      students.forEach(s => { const opt = document.createElement('option'); opt.value=s.id; opt.textContent=s.name; msgStudentSelect.appendChild(opt); });
    }
    function renderStudentsTab(students) {
      const q = (document.getElementById('studentSearch').value || '').trim();
      const list = students.filter(s => !q || s.name.includes(q));
      studentsList.innerHTML = '';
      list.forEach(s => {
        const card = document.createElement('div'); card.className='card';
        
        // Row 1: Name & Actions (Edit + Delete)
        const top = document.createElement('div'); top.style.display='flex'; top.style.justifyContent='space-between'; top.style.alignItems='center'; top.style.marginBottom='8px';
        const name = document.createElement('div'); name.style.fontWeight='bold'; name.textContent = s.name;
        
        const btnGroup = document.createElement('div'); btnGroup.style.display='flex'; btnGroup.style.gap='4px';

        const editBtn = document.createElement('button'); editBtn.className='secondary'; editBtn.textContent='ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù…';
        editBtn.style.padding='4px 8px'; editBtn.style.fontSize='12px';
        editBtn.addEventListener('click', async ()=>{
          const out = await openModal('ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±', [
            { id:'guardianPhone', label:'Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±', placeholder:'05xxxxxxxx', type:'tel' }
          ]);
          if (!out) return;
          s.guardianPhone = out.guardianPhone || s.guardianPhone || '';
          store.save(); renderStudentsTab(students);
        });

        const delBtn = document.createElement('button'); delBtn.className='danger'; delBtn.textContent='Ø­Ø°Ù';
        delBtn.style.padding='4px 8px'; delBtn.style.fontSize='12px';
        delBtn.addEventListener('click', ()=>{
            if(confirm('Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨Ø© "'+s.name+'" ÙˆØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ØŸ')) {
                store.data.students = store.data.students.filter(x=>x.id!==s.id);
                store.data.attendance = store.data.attendance.filter(x=>x.studentId!==s.id);
                store.data.notes = store.data.notes.filter(x=>x.studentId!==s.id);
                store.data.submissions = store.data.submissions.filter(x=>x.studentId!==s.id);
                store.save();
                renderStudentsForClass();
                showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨Ø©');
            }
        });

        btnGroup.appendChild(editBtn); btnGroup.appendChild(delBtn);
        top.appendChild(name); top.appendChild(btnGroup); card.appendChild(top);

        // Row 2: Stars System (New)
        const starsRow = document.createElement('div'); 
        starsRow.style.display='flex'; starsRow.style.alignItems='center'; starsRow.style.gap='8px'; starsRow.style.background='#f9f9f9'; starsRow.style.padding='8px'; starsRow.style.borderRadius='8px'; starsRow.style.marginBottom='8px';
        
        const starsCount = document.createElement('span'); 
        starsCount.style.fontSize='18px'; starsCount.style.fontWeight='bold'; starsCount.style.color='#f39c12';
        starsCount.textContent = `â­ ${s.stars || 0}`;
        
        const addStar = document.createElement('button'); addStar.className='primary'; addStar.textContent='+'; addStar.style.padding='4px 12px';
        addStar.addEventListener('click', ()=>{ 
            s.stars = (s.stars || 0) + 1; 
            store.save(); 
            starsCount.textContent = `â­ ${s.stars}`; 
            try{ new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg').play().catch(()=>{}); }catch(e){}
        });

        const removeStar = document.createElement('button'); removeStar.className='secondary'; removeStar.textContent='-'; removeStar.style.padding='4px 12px';
        removeStar.addEventListener('click', ()=>{ 
            if((s.stars||0) > 0) { s.stars--; store.save(); starsCount.textContent = `â­ ${s.stars}`; }
        });

        const shareStars = document.createElement('button'); shareStars.className='secondary'; shareStars.textContent='ğŸ“± Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ±';
        shareStars.addEventListener('click', ()=>{
             const tpl = store.data.templates.find(t=>t.key==='ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù†Ø¬ÙˆÙ…');
             if(!tpl) return alert('Ù‚Ø§Ù„Ø¨ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø¬ÙˆÙ… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
             const msgText = tpl.text.replace('{name}', s.name).replace('{stars}', s.stars||0);
             const phone = (s.guardianPhone || '').replace(/\D/g,'');
             if (!phone) return alert('Ø£Ø¶ÙŠÙÙŠ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ø·Ø§Ù„Ø¨');
             const url = `https://wa.me/966${phone.startsWith('0')?phone.slice(1):phone}?text=${encodeURIComponent(msgText)}`;
             window.open(url, '_blank');
        });

        starsRow.appendChild(starsCount);
        starsRow.appendChild(addStar);
        starsRow.appendChild(removeStar);
        starsRow.appendChild(shareStars);
        card.appendChild(starsRow);

        // Row 3: Notes & Badge
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.alignItems='center';
        const notesCount = store.data.notes.filter(n=>n.studentId===s.id).length;
        const notesBadge = document.createElement('span'); notesBadge.className='muted'; notesBadge.textContent = `Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${notesCount}`;
        
        const addNoteBtn = document.createElement('button'); addNoteBtn.className='secondary'; addNoteBtn.textContent='Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©';
        addNoteBtn.addEventListener('click', async ()=>{
          const out = await openModal('Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©', [
            { id:'noteText', label:'Ù†Øµ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©', placeholder:'Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©' },
            { id:'noteType', label:'Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© (Ø³Ù„ÙˆÙƒ/Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ/Ø¹Ø§Ù…)', placeholder:'Ø¹Ø§Ù…' }
          ]);
          if (!out || !out.noteText) return;
          const type = out.noteType || 'Ø¹Ø§Ù…';
          store.data.notes.push({ id: store.uid(), studentId: s.id, date: new Date().toISOString().slice(0,10), text: out.noteText, type });
          store.save(); renderStudentsTab(students);
        });
        actions.appendChild(addNoteBtn); actions.appendChild(notesBadge); card.appendChild(actions);
        studentsList.appendChild(card);
      });
    }
    function markAttendance(studentId, present) {
      const date = todayInput.value; const classId = classSelect.value;
      const existing = store.data.attendance.find(a => a.date===date && a.classId===classId && a.studentId===studentId);
      if (existing) existing.present = present;
      else store.data.attendance.push({ id: store.uid(), date, classId, studentId, present });
    }
    document.getElementById('saveAttendanceBtn').addEventListener('click', () => { store.save(); alert('ØªÙ… Ø­ÙØ¸ Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…'); });
    document.getElementById('allPresentBtn').addEventListener('click', ()=>{
      const cid = classSelect.value;
      store.data.students.filter(s=>s.classId===cid).forEach(s=> markAttendance(s.id, true));
      renderStudentsForClass(); showToast('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ Ø­Ø§Ø¶Ø±');
    });
    document.getElementById('allAbsentBtn').addEventListener('click', ()=>{
      const cid = classSelect.value;
      store.data.students.filter(s=>s.classId===cid).forEach(s=> markAttendance(s.id, false));
      renderStudentsForClass(); showToast('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„ ØºØ§Ø¦Ø¨');
    });

    // Modal
    const modal = document.createElement('div'); modal.className='modal';
    modal.innerHTML = `<div class="box">
      <h3 id="modalTitle"></h3>
      <div id="modalContent"></div>
      <div class="actions">
        <button id="modalCancel" class="secondary">Ø¥Ù„ØºØ§Ø¡</button>
        <button id="modalOk" class="primary">ØªÙ†ÙÙŠØ°</button>
      </div>
    </div>`;
    document.body.appendChild(modal);
    function openModal(title, fields) {
      return new Promise((resolve) => {
        document.getElementById('modalTitle').textContent = title;
        const content = document.getElementById('modalContent');
        content.innerHTML = '';
        const inputs = {};
        fields.forEach(f=>{
          const wrap = document.createElement('div'); wrap.className='input';
          const label = document.createElement('label'); label.textContent = f.label;
          const input = document.createElement('input'); input.placeholder = f.placeholder || ''; input.type = f.type || 'text';
          input.id = f.id; wrap.appendChild(label); wrap.appendChild(input); content.appendChild(wrap);
          inputs[f.id] = input;
        });
        modal.style.display='flex';
        const ok = document.getElementById('modalOk');
        const cancel = document.getElementById('modalCancel');
        const close = () => { modal.style.display='none'; ok.onclick=null; cancel.onclick=null; };
        cancel.onclick = () => { close(); resolve(null); };
        ok.onclick = () => {
          const values = {};
          fields.forEach(f=>{ values[f.id] = inputs[f.id].value.trim(); });
          close(); resolve(values);
        };
      });
    }
    document.getElementById('addClassBtn').addEventListener('click', async () => {
      const values = await openModal('Ø¥Ø¶Ø§ÙØ© ÙØµÙ„', [{ id:'className', label:'Ø§Ø³Ù… Ø§Ù„ÙØµÙ„', placeholder:'Ù…Ø«Ù„: Ø£ÙˆÙ„Ù‰/Ø«Ø§Ù†ÙŠØ©' }]);
      if (!values || !values.className) return;
      store.data.classes.push({ id: store.uid(), name: values.className });
      store.save(); renderClassSelect(); renderStudentsForClass();
    });
    document.getElementById('addStudentBtn').addEventListener('click', async () => {
      const values = await openModal('Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨/Ø©', [
        { id:'studentName', label:'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©', placeholder:'Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ø§Ø³Ù…' },
        { id:'guardianPhone', label:'Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±', placeholder:'05xxxxxxxx', type:'tel' }
      ]);
      if (!values || !values.studentName) return showToast('Ø£Ø¯Ø®Ù„ÙŠ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©');
      const normPhone = normalizePhone(values.guardianPhone || '');
      if (values.guardianPhone && !normPhone.valid) { showToast('Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± ØºÙŠØ± ØµØ­ÙŠØ­'); return; }
      store.data.students.push({ id: store.uid(), name: values.studentName, guardianPhone: normPhone.display || '', classId: classSelect.value });
      store.save(); renderStudentsForClass();
    });
    function normalizePhone(input){
      const digits = (input||'').replace(/\D/g,'');
      if (!digits) return { valid:false, display:'' };
      // Accept SA numbers starting with 05xxxxxxxx or 9665xxxxxxxx
      if (digits.length===10 && digits.startsWith('05')) return { valid:true, display: digits };
      if (digits.length===12 && digits.startsWith('9665')) return { valid:true, display: '0'+digits.slice(3) };
      return { valid:false, display:'' };
    }

    const assignmentsList = document.getElementById('assignmentsList');
    function renderAssignments() {
      assignmentsList.innerHTML = '';
      const cid = classSelect.value;
      store.data.assignments.filter(a => a.classId===cid).forEach(a => {
        const card = document.createElement('div'); card.className='card';
        const title = document.createElement('div'); title.textContent = `${a.title} â€” Ø§Ù„ØªØ³Ù„ÙŠÙ…: ${a.dueDate}`;
        const students = store.data.students.filter(s=>s.classId===cid);
        const list = document.createElement('div'); list.style.display='grid'; list.style.gap='6px';
        students.forEach(s=>{
          const row = document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='1fr auto';
          const name = document.createElement('div'); name.textContent=s.name;
          const doneBtn = document.createElement('button'); doneBtn.className='secondary'; doneBtn.textContent='Ø¥Ù†Ø¬Ø§Ø²';
          const exists = store.data.submissions.find(x=>x.assignmentId===a.id && x.studentId===s.id);
          if (exists) { doneBtn.className='primary'; doneBtn.textContent='Ù…ÙÙ†Ø¬Ø²'; }
          doneBtn.addEventListener('click', ()=>{
            const sub = store.data.submissions.find(x=>x.assignmentId===a.id && x.studentId===s.id);
            if (sub) { store.data.submissions = store.data.submissions.filter(x=>x!==sub); }
            else store.data.submissions.push({ id: store.uid(), assignmentId:a.id, studentId:s.id, done:true });
            store.save(); renderAssignments();
          });
          row.appendChild(name); row.appendChild(doneBtn); list.appendChild(row);
        });
        card.appendChild(title); card.appendChild(list); assignmentsList.appendChild(card);
      });
    }
    document.getElementById('createAssignmentBtn').addEventListener('click', () => {
      const title = document.getElementById('asTitle').value.trim(); if (!title) return alert('Ø§ÙƒØªØ¨ÙŠ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ§Ø¬Ø¨');
      const due = document.getElementById('asDue').value; if (!due) return alert('Ø­Ø¯Ø¯ÙŠ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ù„ÙŠÙ…');
      store.data.assignments.push({ id: store.uid(), title, dueDate: due, classId: classSelect.value });
      store.save(); document.getElementById('asTitle').value=''; renderAssignments(); alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ø¨');
    });

    function renderTemplatesSelect() {
      const sel = document.getElementById('msgTemplateSelect');
      sel.innerHTML = '';
      store.data.templates.forEach(t=>{
        const opt = document.createElement('option'); opt.value = t.id; opt.textContent = t.key; sel.appendChild(opt);
      });
    }
    renderTemplatesSelect();
    document.getElementById('sendMsgBtn').addEventListener('click', () => {
      const sid = msgStudentSelect.value;
      const student = store.data.students.find(s=>s.id===sid);
      if (!student) return alert('Ø§Ø®ØªØ§Ø±ÙŠ Ø·Ø§Ù„Ø¨/Ø©');
      const tplId = document.getElementById('msgTemplateSelect').value;
      const tpl = store.data.templates.find(t=>t.id===tplId);
      const msgText = (tpl?.text || '').replace('{name}', student.name).replace('{title}', document.getElementById('asTitle').value || '');
      const msg = encodeURIComponent(msgText);
      const phone = (student.guardianPhone || '').replace(/\D/g,'');
      if (!phone) return alert('Ø£Ø¶ÙŠÙÙŠ Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ø·Ø§Ù„Ø¨');
      const url = `https://wa.me/966${phone.startsWith('0')?phone.slice(1):phone}?text=${msg}`;
      window.open(url, '_blank');
    });
    const templatesEditorBtn = document.createElement('button');
    templatesEditorBtn.className='secondary'; templatesEditorBtn.textContent='Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ù„Ø¨ Ø±Ø³Ø§Ù„Ø©';
    document.getElementById('messages').appendChild(templatesEditorBtn);
    templatesEditorBtn.addEventListener('click', ()=>{
      const key = prompt('Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¸Ø§Ù‡Ø± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©') || ''; if (!key.trim()) return;
      const text = prompt('Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… {name} Ùˆ {title})') || ''; if (!text.trim()) return;
      store.data.templates.push({ id: store.uid(), key, text }); store.save(); renderTemplatesSelect(); alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø§Ù„Ø¨');
    });

    document.getElementById('weeklyReportBtn').addEventListener('click', () => {
      const cid = classSelect.value;
      const start = new Date(todayInput.value); const weekStart = new Date(start); weekStart.setDate(start.getDate()-start.getDay());
      const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate()+6);
      const inRange = (d) => { const x=new Date(d); return x>=weekStart && x<=weekEnd; };
      const rows = [['Student','Date','Present','Assignment','Done']];
      const studs = store.data.students.filter(s=>s.classId===cid);
      studs.forEach(s=>{
        store.data.attendance.filter(a=>a.classId===cid && a.studentId===s.id && inRange(a.date))
          .forEach(a=>rows.push([s.name,a.date,a.present?'Yes':'No','','']));
        store.data.assignments.filter(a=>a.classId===cid && inRange(a.dueDate)).forEach(a=>{
          const done = !!store.data.submissions.find(x=>x.assignmentId===a.id && x.studentId===s.id);
          rows.push([s.name,a.dueDate,'',a.title,done?'Yes':'No']);
        });
      });
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='weekly_report.csv'; a.click();
      document.getElementById('reportStatus').textContent = 'ØªÙ… ØªÙ†Ø²ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± CSV';
    });

    document.getElementById('savePinBtn').addEventListener('click', () => {
      const pin = document.getElementById('pinInput').value.trim();
      if (pin && !/^\d{4}$/.test(pin)) return alert('Ø£Ø¯Ø®Ù„ÙŠ 4 Ø£Ø±Ù‚Ø§Ù…');
      store.data.pin = pin; store.save(); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸');
    });
    async function enforcePin(){
      const pin = store.data.pin; if (!pin) return;
      while (true) {
        const out = await openModal('Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„', [
          { id:'pinEntry', label:'Ø£Ø¯Ø®Ù„ÙŠ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„', placeholder:'****', type:'password' }
        ]);
        if (!out) continue;
        if (out.pinEntry === pin) break;
        showToast('Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­');
      }
    }
    enforcePin();

    document.querySelectorAll('nav button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });
    document.getElementById('studentSearch').addEventListener('input', ()=> renderStudentsForClass());

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(store.data)], {type:'application/json'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='teacher_app_backup.json'; a.click();
    });
    document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if (!file) return;
      try { const text = await file.text(); const data = JSON.parse(text);
        if (!data.classes || !data.students) throw new Error('Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­');
        store.data = data; store.save(); renderClassSelect(); renderStudentsForClass(); renderAssignments();
        alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
      } catch { alert('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'); }
    });

    renderClassSelect(); renderStudentsForClass(); renderAssignments();
    renderPrepList();
    classSelect.addEventListener('change', ()=>{ renderStudentsForClass(); renderAssignments(); renderPrepList(); });

    // Settings: add theme toggle
    const settingsSection = document.getElementById('settings');
    const themeCard = document.createElement('div'); themeCard.className='card';
    themeCard.innerHTML = `
      <div class="input">
        <label>Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</label>
        <select id="themeSelect">
          <option value="">Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</option>
          <option value="light">ÙØ§ØªØ­</option>
          <option value="dark">Ø¯Ø§ÙƒÙ†</option>
        </select>
      </div>`;
    settingsSection.appendChild(themeCard);
    const themeSelect = document.getElementById('themeSelect');
    themeSelect.value = store.data.theme || '';
    themeSelect.addEventListener('change', ()=>{
      store.data.theme = themeSelect.value;
      store.save();
      document.documentElement.setAttribute('data-theme', store.data.theme || '');
      showToast('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¸Ù‡Ø±');
    });

    // Share App QR Code
    const shareCard = document.createElement('div'); shareCard.className='card';
    shareCard.innerHTML = `
      <div style="text-align:center;">
        <h3>Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (QR Code)</h3>
        <p class="muted">Ø§Ù…Ø³Ø­ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø´Ø§Ø±ÙƒÙŠÙ‡ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª</p>
        <div id="qrContainer" style="margin:16px 0;"></div>
        <p id="appLinkText" style="direction:ltr; font-family:monospace; word-break:break-all; font-size:0.9rem;"></p>
        <button id="copyLinkBtn" class="secondary">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
      </div>
    `;
    settingsSection.appendChild(shareCard);
    
    const currentUrl = window.location.href.split('#')[0].split('?')[0]; 
    document.getElementById('appLinkText').textContent = currentUrl;
    
    const qrImg = document.createElement('img');
    qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(currentUrl)}`;
    qrImg.alt = 'QR Code';
    qrImg.style.maxWidth = '100%';
    qrImg.style.border = '1px solid #ddd';
    qrImg.style.padding = '8px';
    qrImg.style.borderRadius = '8px';
    document.getElementById('qrContainer').appendChild(qrImg);

    document.getElementById('copyLinkBtn').addEventListener('click', () => {
       navigator.clipboard.writeText(currentUrl).then(() => showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·'));
    });

    // Prep (lesson preparation)
    if (!Array.isArray(store.data.preps)) store.data.preps = [];

    const suggestPrepBtn = document.getElementById('suggestPrepBtn');
    if (suggestPrepBtn) {
      suggestPrepBtn.addEventListener('click', ()=>{
        const subject = document.getElementById('prepSubject').value;
        const suggestions = {
          'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©': { topic:'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬Ù‡Ø±ÙŠØ©', objectives:'- Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ Ù‚Ø±Ø§Ø¡Ø© ØµØ­ÙŠØ­Ø©.\n- ÙÙ‡Ù… Ù…Ø¹Ø§Ù†ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.', activities:'- Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©.\n- Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø²Ù…Ø±ÙŠØ©.\n- Ù…Ù†Ø§Ù‚Ø´Ø© Ø§Ù„Ø£ÙÙƒØ§Ø±.', materials:'Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØŒ Ø§Ù„Ø³Ø¨ÙˆØ±Ø©ØŒ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙƒÙ„Ù…Ø§Øª', homework:'Ù†Ø³Ø® Ø§Ù„ÙÙ‚Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰' },
          'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª': { topic:'Ø§Ù„Ø¬Ù…Ø¹', objectives:'- Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹.\n- Ø¬Ù…Ø¹ Ø¹Ø¯Ø¯ÙŠÙ† Ø¶Ù…Ù† 99.', activities:'- Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ø³ÙˆØ³Ø§Øª.\n- Ø­Ù„ Ù…Ø³Ø§Ø¦Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¨ÙˆØ±Ø©.\n- Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙƒØªØ§Ø¨.', materials:'Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ Ù…ÙƒØ¹Ø¨Ø§ØªØŒ Ø§Ù„Ø³Ø¨ÙˆØ±Ø©', homework:'Ø­Ù„ ØµÙØ­Ø© Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ†' },
          'Ø§Ù„Ø¹Ù„ÙˆÙ…': { topic:'Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù†Ø¨Ø§Øª', objectives:'- ØªØ­Ø¯ÙŠØ¯ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù†Ø¨Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.\n- Ù…Ø¹Ø±ÙØ© ÙˆØ¸ÙŠÙØ© ÙƒÙ„ Ø¬Ø²Ø¡.', activities:'- Ø¹Ø±Ø¶ Ù†Ø¨Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠ.\n- Ø±Ø³Ù… Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù†Ø¨Ø§Øª.\n- ÙÙŠØ¯ÙŠÙˆ ØªØ¹Ù„ÙŠÙ…ÙŠ.', materials:'Ù†Ø¨ØªØ© Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ Ø¹Ø¯Ø³Ø© Ù…ÙƒØ¨Ø±Ø©ØŒ ÙÙŠØ¯ÙŠÙˆ', homework:'Ø±Ø³Ù… Ù†Ø¨ØªØ© ÙˆØªÙ„ÙˆÙŠÙ†Ù‡Ø§' },
          'Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©': { topic:'Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø¥Ø³Ù„Ø§Ù…', objectives:'- ØªØ¹Ø¯Ø§Ø¯ Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø¥Ø³Ù„Ø§Ù… Ø§Ù„Ø®Ù…Ø³Ø©.\n- Ø­ÙØ¸ Ø­Ø¯ÙŠØ« Ø¨Ù†ÙŠ Ø§Ù„Ø¥Ø³Ù„Ø§Ù… Ø¹Ù„Ù‰ Ø®Ù…Ø³.', activities:'- Ø§Ù†Ø´ÙˆØ¯Ø© Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø¥Ø³Ù„Ø§Ù….\n- ØªÙ„ÙˆÙŠÙ† Ø´Ø¬Ø±Ø© Ø§Ù„Ø£Ø±ÙƒØ§Ù†.', materials:'Ù„ÙˆØ­Ø© Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ØŒ Ù…Ø³Ø¬Ù„', homework:'ØªØ³Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¯ÙŠØ« ØºØ¯Ø§Ù‹' },
          'Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª': { topic:'Ø£Ø³Ø±ØªÙŠ', objectives:'- Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ù…ÙÙ‡ÙˆÙ… Ø§Ù„Ø£Ø³Ø±Ø©.\n- Ø§Ø­ØªØ±Ø§Ù… Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†.', activities:'- Ø¹Ø±Ø¶ ØµÙˆØ± Ù„Ø£Ø³Ø±Ø©.\n- ØªØ­Ø¯Ø« Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª Ø¹Ù† Ø£Ø³Ø±Ù‡Ù†.', materials:'ØµÙˆØ±ØŒ Ù„ÙˆØ­Ø§Øª', homework:'Ø¥Ù„ØµØ§Ù‚ ØµÙˆØ±Ø© Ù„Ù„Ø£Ø³Ø±Ø©' },
          'Ø§Ù„ÙÙ†ÙˆÙ†': { topic:'Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©', objectives:'- Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.\n- Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø¨ÙŠÙ†Ù‡Ø§.', activities:'- Ø¹Ø±Ø¶ Ù†Ù…Ø§Ø°Ø¬ Ù…Ù„ÙˆÙ†Ø©.\n- Ø§Ù„ØªÙ„ÙˆÙŠÙ† Ø¨Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø§Ø¦ÙŠØ©.', materials:'ÙƒØ±Ø§Ø³Ø©ØŒ Ø£Ù„ÙˆØ§Ù† Ù…Ø§Ø¦ÙŠØ©', homework:'Ø±Ø³Ù… Ù…Ù†Ø¸Ø± Ø·Ø¨ÙŠØ¹ÙŠ' },
          'Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©': { topic:'Ø§Ù„ÙˆÙ‚ÙˆÙ Ø§Ù„ØµØ­ÙŠØ­', objectives:'- Ù…Ø¹Ø±ÙØ© ÙˆØ¶Ø¹ÙŠØ© Ø§Ù„ÙˆÙ‚ÙˆÙ Ø§Ù„ØµØ­ÙŠØ­.\n- ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆÙ‚ÙˆÙ ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±.', activities:'- ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„Ø¥Ø­Ù…Ø§Ø¡.\n- ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆÙ‚ÙˆÙ Ø§Ù„Ù…Ø¹ØªØ¯Ù„.', materials:'ØµØ§ÙØ±Ø©ØŒ Ø³Ø§Ø­Ø©', homework:'Ù…Ù…Ø§Ø±Ø³Ø© Ø§Ù„Ù…Ø´ÙŠ' }
        };
        const s = suggestions[subject] || { topic:'Ø¯Ø±Ø³ Ø¹Ø§Ù…', objectives:'- Ù‡Ø¯Ù Ù…Ø¹Ø±ÙÙŠ.\n- Ù‡Ø¯Ù ÙˆØ¬Ø¯Ø§Ù†ÙŠ.', activities:'- Ø§Ù„ØªÙ…Ù‡ÙŠØ¯.\n- Ø§Ù„Ø¹Ø±Ø¶.\n- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.', materials:'Ø§Ù„Ø³Ø¨ÙˆØ±Ø©ØŒ Ø§Ù„ÙƒØªØ§Ø¨', homework:'' };
        
        document.getElementById('prepTopic').value = s.topic;
        document.getElementById('prepObjectives').value = s.objectives;
        document.getElementById('prepActivities').value = s.activities;
        document.getElementById('prepMaterials').value = s.materials;
        document.getElementById('prepHomework').value = s.homework;
        showToast('ØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù‚ØªØ±Ø§Ø­ Ù„Ù€ ' + subject);
      });
    }

    document.getElementById('savePrepBtn').addEventListener('click', ()=>{
      const classId = classSelect.value;
      const date = (prepDateInput && prepDateInput.value) || todayInput.value;
      const subject = document.getElementById('prepSubject').value;
      const topic = document.getElementById('prepTopic').value.trim();
      const objectives = document.getElementById('prepObjectives').value.trim();
      const activities = document.getElementById('prepActivities').value.trim();
      const materials = document.getElementById('prepMaterials').value.trim();
      const homework = document.getElementById('prepHomework').value.trim();
      const notes = document.getElementById('prepNotes').value.trim();
      if (!topic) return showToast('Ø§ÙƒØªØ¨ÙŠ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³');
      const prep = { id: store.uid(), classId, date, subject, topic, objectives, activities, materials, homework, notes };
      store.data.preps.push(prep); store.save();
      renderPrepList(); showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¶ÙŠØ±');
    });
    function renderPrepList(){
      const cid = classSelect.value;
      const fdate = prepFilterDateInput && prepFilterDateInput.value;
      const items = store.data.preps.filter(p => p.classId===cid && (!fdate || p.date===fdate));
      prepList.innerHTML = '';
      if (!items.length) { prepList.innerHTML = '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¶ÙŠØ± Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®</div>'; return; }
      items.forEach(p=>{
        const card = document.createElement('div'); card.className='card';
        const title = document.createElement('div'); title.style.fontWeight='600';
        title.textContent = `${p.subject} â€” ${p.topic} (${p.date})`;
        const body = document.createElement('div'); body.style.marginTop='8px';
        body.innerHTML = `
          <div><span class="muted">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù:</span> ${p.objectives || '-'}</div>
          <div><span class="muted">Ø§Ù„Ø£Ù†Ø´Ø·Ø©:</span> ${p.activities || '-'}</div>
          <div><span class="muted">Ø§Ù„ÙˆØ³Ø§Ø¦Ù„:</span> ${p.materials || '-'}</div>
          <div><span class="muted">Ø§Ù„ÙˆØ§Ø¬Ø¨:</span> ${p.homework || '-'}</div>
          <div><span class="muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span> ${p.notes || '-'}</div>`;
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
        const printBtn = document.createElement('button'); printBtn.className='secondary'; printBtn.textContent='Ø·Ø¨Ø§Ø¹Ø© ÙˆØ±Ù‚Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ±';
        printBtn.addEventListener('click', ()=> printPrep(p));
        const delBtn = document.createElement('button'); delBtn.className='danger'; delBtn.textContent='Ø­Ø°Ù';
        delBtn.addEventListener('click', ()=>{
          if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØªØ­Ø¶ÙŠØ±ØŸ')) return;
          store.data.preps = store.data.preps.filter(x=>x.id!==p.id); store.save(); renderPrepList();
        });
        actions.appendChild(printBtn); actions.appendChild(delBtn);
        card.appendChild(title); card.appendChild(body); card.appendChild(actions);
        prepList.appendChild(card);
      });
    }
    function printPrep(p){
      const html = `
      <html dir="rtl" lang="ar"><head><meta charset="UTF-8"><title>ÙˆØ±Ù‚Ø© ØªØ­Ø¶ÙŠØ±</title>
      <style>
      body{font-family:'Segoe UI',Tahoma,Arial,sans-serif;padding:24px;color:#222}
      h2{margin:0 0 12px 0;color:#2c3e50}
      .row{margin-bottom:8px}
      .label{color:#555;font-weight:bold}
      .box{border:1px solid #ddd;border-radius:8px;padding:12px;margin-top:6px}
      </style></head><body>
      <h2>ÙˆØ±Ù‚Ø© ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¯Ø±Ø³</h2>
      <div class="row"><span class="label">Ø§Ù„ÙØµÙ„:</span> ${store.data.classes.find(c=>c.id===p.classId)?.name || ''}</div>
      <div class="row"><span class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> ${p.date}</div>
      <div class="row"><span class="label">Ø§Ù„Ù…Ø§Ø¯Ø©:</span> ${p.subject}</div>
      <div class="row"><span class="label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³:</span> ${p.topic}</div>
      <div class="box"><div class="label">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</div><div>${(p.objectives||'').replace(/\n/g,'<br>') || '-'}</div></div>
      <div class="box"><div class="label">Ø§Ù„Ø£Ù†Ø´Ø·Ø© / Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª</div><div>${(p.activities||'').replace(/\n/g,'<br>') || '-'}</div></div>
      <div class="box"><div class="label">Ø§Ù„ÙˆØ³Ø§Ø¦Ù„ / Ø§Ù„Ù…ÙˆØ§Ø¯</div><div>${(p.materials||'').replace(/\n/g,'<br>') || '-'}</div></div>
      <div class="box"><div class="label">Ø§Ù„ÙˆØ§Ø¬Ø¨</div><div>${(p.homework||'').replace(/\n/g,'<br>') || '-'}</div></div>
      <div class="box"><div class="label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªÙ‚ÙŠÙŠÙ…ÙŠØ©</div><div>${(p.notes||'').replace(/\n/g,'<br>') || '-'}</div></div>
      </body></html>`;
      const w = window.open('', '_blank'); w.document.write(html); w.document.close();
      w.focus();
      w.print();
    }
    prepFilterDateInput && prepFilterDateInput.addEventListener('change', renderPrepList);
    document.getElementById('exportPrepBtn').addEventListener('click', ()=>{
      const cid = classSelect.value;
      const fdate = prepFilterDateInput && prepFilterDateInput.value;
      const rows = [['Ø§Ù„ÙØµÙ„','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù…Ø§Ø¯Ø©','Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³','Ø§Ù„Ø£Ù‡Ø¯Ø§Ù','Ø§Ù„Ø£Ù†Ø´Ø·Ø©','Ø§Ù„ÙˆØ³Ø§Ø¦Ù„','Ø§Ù„ÙˆØ§Ø¬Ø¨','Ù…Ù„Ø§Ø­Ø¸Ø§Øª']];
      const cname = (store.data.classes.find(c=>c.id===cid)?.name) || '';
      const esc = (s)=>('"'+String(s||'').replace(/"/g,'""').replace(/\r?\n/g,' ').trim()+'"');
      store.data.preps.filter(p=>p.classId===cid && (!fdate || p.date===fdate)).forEach(p=>{
        rows.push([cname,p.date,p.subject,p.topic,p.objectives,p.activities,p.materials,p.homework,p.notes].map(esc));
      });
      const bom = '\ufeff';
      const csv = bom + rows.map(r=>Array.isArray(r)?r.join(','):r).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = fdate ? `ØªØ­Ø¶ÙŠØ±_${cname}_${fdate}.csv` : `ØªØ­Ø¶ÙŠØ±_${cname}.csv`; a.click();
    });

    // Prep V2: Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ ÙˆÙØ±Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    (function rebuildPrepModule(){
      if (!Array.isArray(store.data.preps)) store.data.preps = [];
      const prepSearchInput = document.getElementById('prepSearch');
      let editingPrepId = null;
      function getClassName(cid){ return (store.data.classes.find(c=>c.id===cid)?.name) || ''; }
      function collectPrepForm(){
        return {
          classId: classSelect.value,
          date: (prepDateInput && prepDateInput.value) || todayInput.value,
          subject: document.getElementById('prepSubject').value,
          topic: document.getElementById('prepTopic').value.trim(),
          objectives: document.getElementById('prepObjectives').value.trim(),
          activities: document.getElementById('prepActivities').value.trim(),
          materials: document.getElementById('prepMaterials').value.trim(),
          homework: document.getElementById('prepHomework').value.trim(),
          notes: document.getElementById('prepNotes').value.trim(),
        };
      }
      function resetPrepForm(){
        document.getElementById('prepTopic').value='';
        document.getElementById('prepObjectives').value='';
        document.getElementById('prepActivities').value='';
        document.getElementById('prepMaterials').value='';
        document.getElementById('prepHomework').value='';
        document.getElementById('prepNotes').value='';
        editingPrepId = null;
      }
      const btnSaveOld = document.getElementById('savePrepBtn');
      const btnSaveNew = btnSaveOld.cloneNode(true);
      btnSaveOld.parentNode.replaceChild(btnSaveNew, btnSaveOld);
      btnSaveNew.addEventListener('click', ()=>{
        const data = collectPrepForm();
        if (!data.topic) return showToast('Ø§ÙƒØªØ¨ÙŠ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³');
        if (editingPrepId){
          const existing = store.data.preps.find(x=>x.id===editingPrepId);
          if (existing) Object.assign(existing, data);
          editingPrepId = null;
        } else {
          store.data.preps.push({ id: store.uid(), ...data });
        }
        store.save();
        renderPrepListV2();
        showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¶ÙŠØ±');
      });
      const btnReset = document.getElementById('resetPrepBtn');
      btnReset.addEventListener('click', resetPrepForm);
      function renderPrepListV2(){
        const cid = classSelect.value;
        const fdate = prepFilterDateInput && prepFilterDateInput.value;
        const q = (prepSearchInput && prepSearchInput.value || '').trim();
        const items = store.data.preps
          .filter(p => p.classId===cid && (!fdate || p.date===fdate) && (!q || p.topic.includes(q)));
        prepList.innerHTML = '';
        if (!items.length) { prepList.innerHTML = '<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ø¶ÙŠØ± Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>'; return; }
        items.forEach(p=>{
          const card = document.createElement('div'); card.className='card';
          const title = document.createElement('div'); title.style.fontWeight='600';
          title.textContent = `${p.subject} â€” ${p.topic} (${p.date})`;
          const body = document.createElement('div'); body.style.marginTop='8px';
          body.innerHTML = `
            <div><span class="muted">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù:</span> ${p.objectives || '-'}</div>
            <div><span class="muted">Ø§Ù„Ø£Ù†Ø´Ø·Ø©:</span> ${p.activities || '-'}</div>
            <div><span class="muted">Ø§Ù„ÙˆØ³Ø§Ø¦Ù„:</span> ${p.materials || '-'}</div>
            <div><span class="muted">Ø§Ù„ÙˆØ§Ø¬Ø¨:</span> ${p.homework || '-'}</div>
            <div><span class="muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</span> ${p.notes || '-'}</div>`;
          const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
          const editBtn = document.createElement('button'); editBtn.className='secondary'; editBtn.textContent='ØªØ­Ø±ÙŠØ±';
          editBtn.addEventListener('click', ()=>{
            document.getElementById('prepDate').value = p.date;
            document.getElementById('prepSubject').value = p.subject;
            document.getElementById('prepTopic').value = p.topic;
            document.getElementById('prepObjectives').value = p.objectives || '';
            document.getElementById('prepActivities').value = p.activities || '';
            document.getElementById('prepMaterials').value = p.materials || '';
            document.getElementById('prepHomework').value = p.homework || '';
            document.getElementById('prepNotes').value = p.notes || '';
            editingPrepId = p.id;
            showToast('ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø±ÙŠØ± Ù…ÙÙØ¹Ù‘Ù„');
          });
          const printBtn = document.createElement('button'); printBtn.className='secondary'; printBtn.textContent='Ø·Ø¨Ø§Ø¹Ø© ÙˆØ±Ù‚Ø© Ø§Ù„ØªØ­Ø¶ÙŠØ±';
          printBtn.addEventListener('click', ()=> printPrepV2(p));
          const delBtn = document.createElement('button'); delBtn.className='danger'; delBtn.textContent='Ø­Ø°Ù';
          delBtn.addEventListener('click', ()=>{
            if (!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØªØ­Ø¶ÙŠØ±ØŸ')) return;
            store.data.preps = store.data.preps.filter(x=>x.id!==p.id); store.save(); renderPrepListV2();
          });
          actions.appendChild(editBtn); actions.appendChild(printBtn); actions.appendChild(delBtn);
          card.appendChild(title); card.appendChild(body); card.appendChild(actions);
          prepList.appendChild(card);
        });
      }
      function printPrepV2(p){
        const iframe = document.createElement('iframe');
        iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
        iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
        document.body.appendChild(iframe);
        const doc = iframe.contentWindow.document;
        const html = doc.documentElement;
        html.setAttribute('dir','rtl'); html.setAttribute('lang','ar');
        const head = doc.head || doc.createElement('head'); doc.appendChild(head);
        const meta = doc.createElement('meta'); meta.setAttribute('charset','UTF-8'); head.appendChild(meta);
        const title = doc.createElement('title'); title.textContent = 'ÙˆØ±Ù‚Ø© ØªØ­Ø¶ÙŠØ±'; head.appendChild(title);
        const style = doc.createElement('style');
        style.textContent = `
          body{font-family:'Segoe UI',Tahoma,Arial,sans-serif;margin:0;padding:24px;color:#222}
          h2{margin:0 0 12px 0;color:#2c3e50}
          .row{margin-bottom:8px}
          .label{color:#555;font-weight:bold}
          .box{border:1px solid #ddd;border-radius:8px;padding:12px;margin-top:6px}
          @page { size: A4; margin: 16mm; }
        `;
        head.appendChild(style);
        const body = doc.body || doc.createElement('body'); doc.appendChild(body);
        const h2 = doc.createElement('h2'); h2.textContent='ÙˆØ±Ù‚Ø© ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¯Ø±Ø³'; body.appendChild(h2);
        function row(label,text){
          const d = doc.createElement('div'); d.className='row';
          const s = doc.createElement('span'); s.className='label'; s.textContent=label+' ';
          d.appendChild(s); d.appendChild(doc.createTextNode(text||'')); return d;
        }
        function box(label,htmlContent){
          const b = doc.createElement('div'); b.className='box';
          const l = doc.createElement('div'); l.className='label'; l.textContent=label; b.appendChild(l);
          const c = doc.createElement('div'); c.innerHTML = htmlContent || '-'; b.appendChild(c); return b;
        }
        body.appendChild(row('Ø§Ù„ÙØµÙ„:', getClassName(p.classId)));
        body.appendChild(row('Ø§Ù„ØªØ§Ø±ÙŠØ®:', p.date));
        body.appendChild(row('Ø§Ù„Ù…Ø§Ø¯Ø©:', p.subject));
        body.appendChild(row('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³:', p.topic));
        const br = (s)=>String(s||'').replace(/\\n/g,'<br>');
        body.appendChild(box('Ø§Ù„Ø£Ù‡Ø¯Ø§Ù', br(p.objectives)));
        body.appendChild(box('Ø§Ù„Ø£Ù†Ø´Ø·Ø© / Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª', br(p.activities)));
        body.appendChild(box('Ø§Ù„ÙˆØ³Ø§Ø¦Ù„ / Ø§Ù„Ù…ÙˆØ§Ø¯', br(p.materials)));
        body.appendChild(box('Ø§Ù„ÙˆØ§Ø¬Ø¨', br(p.homework)));
        body.appendChild(box('Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªÙ‚ÙŠÙŠÙ…ÙŠØ©', br(p.notes)));
        setTimeout(()=>iframe.contentWindow.print(), 50);
        iframe.contentWindow.addEventListener('afterprint', ()=> { document.body.removeChild(iframe); }, { once:true });
      }
      // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø¨Ø· Ø§Ù„ÙÙ„Ø§ØªØ±
      const fOld = prepFilterDateInput; fOld && fOld.addEventListener('change', renderPrepListV2);
      prepSearchInput && prepSearchInput.addEventListener('input', renderPrepListV2);
      // Ø£ÙˆÙ„ Ø¹Ø±Ø¶
      renderPrepListV2();
      // ØªØ¨Ø¯ÙŠÙ„ Ù…Ø³ØªÙ…Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„ÙØµÙ„ Ù„ÙŠØ³ØªØ®Ø¯Ù… V2
      const classSelOld = classSelect;
      classSelOld.addEventListener('change', renderPrepListV2);
      // Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ ÙˆÙŠÙ‚Ø±Ø£ Ù…Ù† Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©

      // --- Auto Prep Suggestion ---
      const samplePreps = {
        'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©': [
            { topic: 'Ø­Ø±Ù (Ø£)', objectives: '1- Ø£Ù† ØªØªØ¹Ø±Ù Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø¹Ù„Ù‰ Ø­Ø±Ù Ø§Ù„Ø£Ù„Ù.\n2- Ø£Ù† ØªÙ†Ø·Ù‚ Ø§Ù„Ø­Ø±Ù Ø¨Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø«Ù„Ø§Ø«.', activities: 'Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ù„Ø­Ø±Ù - ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø­Ø±Ù ÙÙŠ Ø§Ù„Ù‡ÙˆØ§Ø¡', materials: 'Ø¨Ø·Ø§Ù‚Ø§Øª Ø­Ø±ÙˆÙ - Ø³Ø¨ÙˆØ±Ø©', homework: 'ÙƒØªØ§Ø¨Ø© Ø­Ø±Ù Ø£ ÙÙŠ Ø§Ù„Ø¯ÙØªØ±' },
            { topic: 'Ù‚Ø±Ø§Ø¡Ø© Ù†Øµ Ù‚ØµÙŠØ±', objectives: '1- Ø£Ù† ØªÙ‚Ø±Ø£ Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø§Ù„Ù†Øµ Ù‚Ø±Ø§Ø¡Ø© ØµØ­ÙŠØ­Ø©.\n2- Ø£Ù† ØªØ³ØªØ®Ø±Ø¬ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªÙŠ Ø¨Ù‡Ø§ Ù…Ø¯.', activities: 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø²Ù…Ø±ÙŠØ© - Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙØ±Ø¯ÙŠØ©', materials: 'Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠ', homework: 'Ù†Ø³Ø® Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„' }
        ],
        'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª': [
            { topic: 'Ø§Ù„Ø¬Ù…Ø¹ Ø§Ù„Ø¨Ø³ÙŠØ·', objectives: '1- Ø£Ù† ØªØ¬Ù…Ø¹ Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø¹Ø¯Ø¯ÙŠÙ† Ø¶Ù…Ù† 10.\n2- Ø£Ù† ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø³ÙˆØ³Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ù…Ø¹.', activities: 'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ - Ø­Ù„ Ù…Ø³Ø§Ø¦Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¨ÙˆØ±Ø©', materials: 'Ø¹Ø¯Ø§Ø¯Ø§Øª - Ø£Ù‚Ù„Ø§Ù… Ù…Ù„ÙˆÙ†Ø©', homework: 'Ø­Ù„ ØµÙØ­Ø© Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† Ø±Ù‚Ù… 5' },
            { topic: 'Ø§Ù„Ø£Ø´ÙƒØ§Ù„ Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ©', objectives: '1- Ø£Ù† ØªÙ…ÙŠØ² Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙˆØ§Ù„Ù…Ø³ØªØ·ÙŠÙ„.\n2- Ø£Ù† ØªØ°ÙƒØ± Ø£Ù…Ø«Ù„Ø© Ù…Ù† Ø§Ù„ÙØµÙ„.', activities: 'Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø´ÙƒØ§Ù„ ÙÙŠ Ø§Ù„ÙØµÙ„ - Ø§Ù„Ø±Ø³Ù…', materials: 'Ù…Ø¬Ø³Ù…Ø§Øª Ù‡Ù†Ø¯Ø³ÙŠØ©', homework: 'Ø±Ø³Ù… Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ø±Ø© ÙˆÙ…Ø±Ø¨Ø¹' }
        ],
        'Ø§Ù„Ø¹Ù„ÙˆÙ…': [
            { topic: 'Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù†Ø¨Ø§Øª', objectives: '1- Ø£Ù† ØªØ¹Ø¯Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù†Ø¨Ø§Øª.\n2- Ø£Ù† ØªØ°ÙƒØ± ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¬Ø°Ø±.', activities: 'Ø¹Ø±Ø¶ Ù†Ø¨ØªØ© Ø­Ù‚ÙŠÙ‚ÙŠØ© - Ø±Ø³Ù… Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù†Ø¨Ø§Øª', materials: 'Ù†Ø¨ØªØ© - Ù„ÙˆØ­Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©', homework: 'Ø±Ø³Ù… Ù†Ø¨ØªØ© ÙˆØªÙ„ÙˆÙŠÙ†Ù‡Ø§' }
        ],
        'Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©': [
            { topic: 'Ø¢Ø¯Ø§Ø¨ Ø§Ù„Ø·Ø¹Ø§Ù…', objectives: '1- Ø£Ù† ØªØ°ÙƒØ± Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø¯Ø¹Ø§Ø¡ Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¹Ø§Ù….\n2- Ø£Ù† ØªØ·Ø¨Ù‚ Ø¢Ø¯Ø§Ø¨ Ø§Ù„Ø£ÙƒÙ„ Ø¨Ø§Ù„ÙŠÙ…ÙŠÙ†.', activities: 'ØªÙ…Ø«ÙŠÙ„ Ø¯ÙˆØ± - Ø¹Ø±Ø¶ ÙÙŠØ¯ÙŠÙˆ ÙƒØ±ØªÙˆÙ†ÙŠ', materials: 'Ø´Ø§Ø´Ø© Ø¹Ø±Ø¶', homework: 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¢Ø¯Ø§Ø¨ ÙÙŠ Ø§Ù„Ù…Ù†Ø²Ù„' }
        ]
      };
      
      const suggestBtn = document.getElementById('suggestPrepBtn');
      if(suggestBtn){
        suggestBtn.addEventListener('click', ()=>{
            const subj = document.getElementById('prepSubject').value;
            const samples = samplePreps[subj];
            if(!samples || !samples.length) return showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹');
            
            // Pick random
            const p = samples[Math.floor(Math.random() * samples.length)];
            document.getElementById('prepTopic').value = p.topic;
            document.getElementById('prepObjectives').value = p.objectives;
            document.getElementById('prepActivities').value = p.activities;
            document.getElementById('prepMaterials').value = p.materials;
            document.getElementById('prepHomework').value = p.homework;
            showToast('ØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù‚ØªØ±Ø§Ø­ ØªØ­Ø¶ÙŠØ± âœ¨');
        });
      }

    })();

    // --- Tools Logic (Random Picker & Timer) ---
    (function initTools(){
      const pickRandomBtn = document.getElementById('pickRandomBtn');
      const randomPickerResult = document.getElementById('randomPickerResult');
      let pickInterval = null;
      if(pickRandomBtn){
        pickRandomBtn.addEventListener('click', () => {
          const cid = classSelect.value;
          const students = store.data.students.filter(s => s.classId === cid);
          if (!students.length) { showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„'); return; }
          if (pickInterval) clearInterval(pickInterval);
          let count = 0;
          pickRandomBtn.disabled = true;
          pickInterval = setInterval(() => {
            const random = students[Math.floor(Math.random() * students.length)];
            randomPickerResult.textContent = random.name;
            count++;
            if (count > 20) {
              clearInterval(pickInterval);
              pickInterval = null;
              pickRandomBtn.disabled = false;
              randomPickerResult.style.transform = 'scale(1.2)';
              setTimeout(() => randomPickerResult.style.transform = 'scale(1)', 200);
            }
          }, 100);
        });
      }

      const timerDisplay = document.getElementById('timerDisplay');
      let timerSeconds = 300; 
      let timerInterval = null;
      function updateTimerDisplay() {
        const m = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
        const s = (timerSeconds % 60).toString().padStart(2, '0');
        if(timerDisplay) timerDisplay.textContent = `${m}:${s}`;
      }
      const tAdd = document.getElementById('timerAdd1');
      const tSub = document.getElementById('timerSub1');
      const tStart = document.getElementById('timerStartBtn');
      const tPause = document.getElementById('timerPauseBtn');
      const tReset = document.getElementById('timerResetBtn');

      if(tAdd) tAdd.addEventListener('click', () => { timerSeconds += 60; updateTimerDisplay(); });
      if(tSub) tSub.addEventListener('click', () => { if(timerSeconds>=60) timerSeconds -= 60; updateTimerDisplay(); });
      if(tStart) tStart.addEventListener('click', () => {
        if (timerInterval) return;
        timerInterval = setInterval(() => {
          if (timerSeconds > 0) {
            timerSeconds--;
            updateTimerDisplay();
          } else {
            clearInterval(timerInterval);
            timerInterval = null;
            showToast('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!');
            try{ new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{}); }catch(e){}
          }
        }, 1000);
      });
      if(tPause) tPause.addEventListener('click', () => { clearInterval(timerInterval); timerInterval = null; });
      if(tReset) tReset.addEventListener('click', () => { clearInterval(timerInterval); timerInterval = null; timerSeconds = 300; updateTimerDisplay(); });
    })();
  </script>
</body>
</html>
